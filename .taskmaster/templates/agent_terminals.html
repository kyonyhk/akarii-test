<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üñ•Ô∏è Agent Terminals - Multi-Agent Control</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        background: #0a0a0a;
        color: #e2e8f0;
        overflow: hidden;
      }
      .header {
        background: #1a1a2e;
        padding: 15px;
        text-align: center;
        border-bottom: 2px solid #ff6b6b;
      }
      .header h1 {
        color: #ff6b6b;
        font-size: 1.5rem;
        margin-bottom: 5px;
      }
      .header .subtitle {
        color: #94a3b8;
        font-size: 0.9rem;
      }
      .terminals-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        height: calc(100vh - 80px);
      }
      .terminal-container {
        border: 1px solid #374151;
        background: #1e293b;
        display: flex;
        flex-direction: column;
      }
      .terminal-header {
        background: #374151;
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #4b5563;
      }
      .terminal-title {
        color: #60a5fa;
        font-weight: bold;
        font-size: 0.9rem;
      }
      .terminal-status {
        font-size: 0.8rem;
        padding: 2px 8px;
        border-radius: 4px;
      }
      .status-running {
        background: #10b981;
        color: white;
      }
      .status-stopped {
        background: #ef4444;
        color: white;
      }
      .status-paused {
        background: #f59e0b;
        color: black;
      }
      .terminal-controls {
        display: flex;
        gap: 5px;
      }
      .control-btn {
        background: #4b5563;
        border: none;
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.7rem;
      }
      .control-btn:hover {
        background: #6b7280;
      }
      .control-btn.start {
        background: #10b981;
      }
      .control-btn.stop {
        background: #ef4444;
      }
      .control-btn.restart {
        background: #f59e0b;
      }
      .terminal-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .output-area {
        flex: 1;
        background: #0f172a;
        padding: 10px;
        overflow-y: auto;
        font-size: 0.75rem;
        line-height: 1.4;
      }
      .output-line {
        margin-bottom: 2px;
      }
      .output-line.user {
        color: #60a5fa;
      }
      .output-line.agent {
        color: #e2e8f0;
      }
      .output-line.system {
        color: #f59e0b;
      }
      .output-line.error {
        color: #ef4444;
      }
      .timestamp {
        color: #6b7280;
        font-size: 0.7rem;
      }
      .input-area {
        background: #374151;
        padding: 8px;
        border-top: 1px solid #4b5563;
      }
      .input-row {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
      }
      .command-input {
        flex: 1;
        background: #4b5563;
        border: 1px solid #6b7280;
        color: #e2e8f0;
        padding: 5px;
        border-radius: 3px;
        font-size: 0.75rem;
        font-family: inherit;
      }
      .send-btn {
        background: #3b82f6;
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.75rem;
      }
      .send-btn:hover {
        background: #2563eb;
      }
      .quick-commands {
        display: flex;
        gap: 3px;
        flex-wrap: wrap;
      }
      .quick-cmd {
        background: #6b7280;
        border: none;
        color: white;
        padding: 2px 6px;
        border-radius: 2px;
        cursor: pointer;
        font-size: 0.7rem;
      }
      .quick-cmd:hover {
        background: #9ca3af;
      }
      .auto-refresh {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #1e293b;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8rem;
        z-index: 1000;
      }
      .agent-prism {
        border-color: #ec4899;
      }
      .agent-realtime {
        border-color: #10b981;
      }
      .agent-auth {
        border-color: #f59e0b;
      }
      .agent-analytics {
        border-color: #8b5cf6;
      }
      .agent-quality {
        border-color: #06b6d4;
      }
      .agent-review {
        border-color: #f97316;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üñ•Ô∏è Agent Terminals</h1>
      <p class="subtitle">Individual control interfaces for each agent</p>
    </div>

    <div class="auto-refresh">
      üîÑ Auto-refresh: <span id="countdown">3</span>s
    </div>

    <div class="terminals-grid">
      {% for agent in agents %}
      <div class="terminal-container {{ agent }}">
        <div class="terminal-header">
          <div class="terminal-title">{{ agent }}</div>
          <div class="terminal-status" id="status-{{ agent }}">Loading...</div>
          <div class="terminal-controls">
            <button
              class="control-btn start"
              onclick="sendCommand('{{ agent }}', 'start')"
            >
              ‚ñ∂
            </button>
            <button
              class="control-btn stop"
              onclick="sendCommand('{{ agent }}', 'stop')"
            >
              ‚èπ
            </button>
            <button
              class="control-btn restart"
              onclick="sendCommand('{{ agent }}', 'restart')"
            >
              üîÑ
            </button>
          </div>
        </div>

        <div class="terminal-content">
          <div class="output-area" id="output-{{ agent }}">
            <div class="output-line system">
              <span class="timestamp">[System]</span> Terminal initialized for
              {{ agent }}
            </div>
          </div>

          <div class="input-area">
            <div class="input-row">
              <input
                type="text"
                class="command-input"
                id="input-{{ agent }}"
                placeholder="Type command or message..."
                onkeypress="if(event.key==='Enter') sendMessage('{{ agent }}')"
              />
              <button class="send-btn" onclick="sendMessage('{{ agent }}')">
                Send
              </button>
            </div>
            <div class="quick-commands">
              <button
                class="quick-cmd"
                onclick="sendCommand('{{ agent }}', 'pause')"
              >
                Pause
              </button>
              <button
                class="quick-cmd"
                onclick="sendCommand('{{ agent }}', 'resume')"
              >
                Resume
              </button>
              <button
                class="quick-cmd"
                onclick="sendQuickMessage('{{ agent }}', 'status')"
              >
                Status
              </button>
              <button
                class="quick-cmd"
                onclick="sendQuickMessage('{{ agent }}', 'What are you working on?')"
              >
                Current Task
              </button>
              <button class="quick-cmd" onclick="viewLogs('{{ agent }}')">
                Logs
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <script>
      const agents = {{ agents | tojson }};
      let refreshInterval = 3000; // 3 seconds
      let countdownTimer;

      async function loadAllStatuses() {
          try {
              const response = await fetch('/api/agents');
              const statuses = await response.json();

              for (const agentId in statuses) {
                  updateAgentStatus(agentId, statuses[agentId]);
                  await loadAgentOutput(agentId);
              }
          } catch (error) {
              console.error('Error loading statuses:', error);
          }
      }

      function updateAgentStatus(agentId, status) {
          const statusEl = document.getElementById(`status-${agentId}`);
          if (statusEl) {
              const statusClass = status.running ? 'status-running' : 'status-stopped';
              const statusText = status.running ? 'üü¢ RUNNING' : 'üî¥ STOPPED';
              statusEl.className = `terminal-status ${statusClass}`;
              statusEl.textContent = statusText;
          }
      }

      async function loadAgentOutput(agentId) {
          try {
              const response = await fetch(`/api/agent/${agentId}/output?lines=20`);
              const data = await response.json();

              const outputEl = document.getElementById(`output-${agentId}`);
              if (outputEl && data.output) {
                  // Keep existing content and add new
                  const existingLines = outputEl.querySelectorAll('.output-line').length;

                  data.output.forEach(item => {
                      const line = document.createElement('div');
                      line.className = `output-line ${item.source}`;

                      const timestamp = new Date(item.timestamp).toLocaleTimeString();
                      line.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${escapeHtml(item.content)}`;

                      outputEl.appendChild(line);
                  });

                  // Keep only last 50 lines
                  const lines = outputEl.querySelectorAll('.output-line');
                  if (lines.length > 50) {
                      for (let i = 0; i < lines.length - 50; i++) {
                          lines[i].remove();
                      }
                  }

                  // Auto-scroll to bottom
                  outputEl.scrollTop = outputEl.scrollHeight;
              }
          } catch (error) {
              console.error(`Error loading output for ${agentId}:`, error);
          }
      }

      async function sendCommand(agentId, command) {
          try {
              const response = await fetch(`/api/agent/${agentId}/command`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ command })
              });

              const result = await response.json();

              // Add command to output
              addOutputLine(agentId, 'system', `Command: ${command} - ${result.success ? 'Success' : 'Failed: ' + result.error}`);

              // Refresh status
              setTimeout(() => loadAllStatuses(), 1000);
          } catch (error) {
              addOutputLine(agentId, 'error', `Command failed: ${error.message}`);
          }
      }

      async function sendMessage(agentId) {
          const input = document.getElementById(`input-${agentId}`);
          const message = input.value.trim();

          if (!message) return;

          // Add user message to output
          addOutputLine(agentId, 'user', `You: ${message}`);
          input.value = '';

          // Determine if it's a command or message
          if (message.startsWith('/')) {
              const command = message.substring(1);
              await sendCommand(agentId, command);
          } else {
              // Send as injected message
              await sendCommand(agentId, `inject:${message}`);
          }
      }

      async function sendQuickMessage(agentId, message) {
          addOutputLine(agentId, 'user', `You: ${message}`);
          await sendCommand(agentId, `inject:${message}`);
      }

      function addOutputLine(agentId, type, content) {
          const outputEl = document.getElementById(`output-${agentId}`);
          if (outputEl) {
              const line = document.createElement('div');
              line.className = `output-line ${type}`;

              const timestamp = new Date().toLocaleTimeString();
              line.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${escapeHtml(content)}`;

              outputEl.appendChild(line);
              outputEl.scrollTop = outputEl.scrollHeight;
          }
      }

      async function viewLogs(agentId) {
          try {
              const response = await fetch(`/api/agent/${agentId}/logs?lines=200`);
              const data = await response.json();

              const newWindow = window.open('', '_blank');
              newWindow.document.write(`
                  <html>
                      <head>
                          <title>${agentId} - Full Logs</title>
                          <style>
                              body { background: #0f172a; color: #e2e8f0; font-family: monospace; padding: 20px; }
                              .log-line { margin-bottom: 5px; }
                              .timestamp { color: #6b7280; }
                          </style>
                      </head>
                      <body>
                          <h2>${agentId} - Complete Logs</h2>
                          <pre>${data.logs.join('\n')}</pre>
                      </body>
                  </html>
              `);
          } catch (error) {
              addOutputLine(agentId, 'error', `Failed to load logs: ${error.message}`);
          }
      }

      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }

      function startCountdown() {
          let count = 3;
          countdownTimer = setInterval(() => {
              count--;
              document.getElementById('countdown').textContent = count;
              if (count <= 0) {
                  clearInterval(countdownTimer);
                  loadAllStatuses();
                  startCountdown();
              }
          }, 1000);
      }

      // Initialize
      loadAllStatuses();
      startCountdown();

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key >= '1' && e.key <= '6') {
              const agentIndex = parseInt(e.key) - 1;
              if (agentIndex < agents.length) {
                  const agentId = agents[agentIndex];
                  document.getElementById(`input-${agentId}`).focus();
              }
          }
      });
    </script>
  </body>
</html>
